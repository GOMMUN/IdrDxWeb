<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idr.pdd.mapper.DashMapper">
	
	<select id="findAllName" parameterType="FairProd" resultType="FairProd">
		SELECT A.FACTORYNAME AS FACTORYNAME
		FROM DSP_FACTORY A
		WHERE A.FACTORYID = #{plant}
    </select>
    
    <select id="findAllP" parameterType="FairProd" resultType="FairProd">
		SELECT 
			C.WORK_DATE,
			SUM(C.MANHOUR) AS MANHOUR,
			SUM(C.PROD_QTY) AS PROD_QTY
		FROM (		
			SELECT DISTINCT
				A.WORK_DATE,
				B.MANHOUR,
				B.PROD_QTY
			FROM DSP_WORKDAILY_REPORT A
			LEFT JOIN DSP_WORK_CONTENTS B
			ON A.DATASEQ = B.WORKDAILY_SEQ
			WHERE A.WORK_DATE IN (
								CONVERT(DATE, GETDATE()-4, 112),
								CONVERT(DATE, GETDATE()-5, 112)
								)
				AND A.FACTORYID = #{plant}
				AND A.ISUSABLE = 'Usable'
				AND B.ISUSABLE = 'Usable'
			) C
		GROUP BY C.WORK_DATE 
    </select>

    <select id="findAllQ" parameterType="FairProd" resultType="FairProd">
		SELECT 
			C.WORK_DATE,
			SUM(C.FIRSTTIME_FAIL_QTY) AS FIRSTTIME_FAIL_QTY,
			SUM(C.PROD_QTY) AS PROD_QTY
		FROM (		
			SELECT DISTINCT
				A.WORK_DATE,
				B.FIRSTTIME_FAIL_QTY,
				B.PROD_QTY
			FROM DSP_WORKDAILY_REPORT A
			LEFT JOIN DSP_WORK_CONTENTS B
			ON A.DATASEQ = B.WORKDAILY_SEQ
			WHERE A.WORK_DATE IN (
								CONVERT(DATE, GETDATE()-4, 112),
								CONVERT(DATE, GETDATE()-5, 112)
								)
				AND A.FACTORYID = #{plant}
				AND A.ISUSABLE = 'Usable'
				AND B.ISUSABLE = 'Usable'
			) C
		GROUP BY C.WORK_DATE
    </select>
    
    <select id="findAllC" parameterType="FairProd" resultType="FairProd">
		SELECT 
			D.WORK_DATE,
			SUM(D.WORKTOTAL) AS WORKTOTAL,
			SUM(D.NOTOPERATETOTAL) AS NOTOPERATETOTAL
		FROM (		
			SELECT DISTINCT
				A.WORK_DATE,
				
				ISNULL(CASE 
						WHEN (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) 
						THEN ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)))
						ELSE ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT))))
					END,0) AS WORKTOTAL,
					
				ISNULL(CASE 
						WHEN (CAST(SUBSTRING(B.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(B.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_TO,3,2) AS INT)) 
						THEN ((CAST(SUBSTRING(B.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(B.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_FROM,3,2) AS INT)))
						ELSE ((CAST(SUBSTRING(B.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(B.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(B.NOTOPERATETIME_FROM,3,2) AS INT))))
					END,0) AS NOTOPERATETOTAL
			FROM DSP_WORKDAILY_REPORT A
			LEFT JOIN DSP_NOTOPERATE_CONTENTS B
			ON A.DATASEQ = B.WORKDAILY_SEQ
			LEFT JOIN DSP_WORK_CONTENTS C
			ON A.DATASEQ = C.WORKDAILY_SEQ
			WHERE A.WORK_DATE IN (
								CONVERT(DATE, GETDATE()-4, 112),
								CONVERT(DATE, GETDATE()-5, 112)
								)
				AND A.FACTORYID = #{plant}
				AND A.ISUSABLE = 'Usable'
				AND B.ISUSABLE = 'Usable'
				AND C.ISUSABLE = 'Usable'
			) D
		GROUP BY D.WORK_DATE
    </select>
    
    <select id="findAllD" parameterType="FairProd" resultType="FairProd">
		SELECT 
			C.WORK_DATE,
			SUM(C.PLAN_QTY) AS PLAN_QTY,
			SUM(C.PROD_QTY) AS PROD_QTY
		FROM (		
			SELECT DISTINCT
				A.WORK_DATE,
				A.PLAN_QTY,
				B.PROD_QTY
			FROM DSP_WORKDAILY_REPORT A
			LEFT JOIN DSP_WORK_CONTENTS B
			ON A.DATASEQ = B.WORKDAILY_SEQ
			WHERE A.WORK_DATE IN (
								CONVERT(DATE, GETDATE()-4, 112),
								CONVERT(DATE, GETDATE()-5, 112)
								)
				AND A.FACTORYID = #{plant}
				AND A.ISUSABLE = 'Usable'
				AND B.ISUSABLE = 'Usable'
			) C
		GROUP BY C.WORK_DATE
    </select>
    
	<select id="rank">
		SELECT 
			R.LOCATIONID, 
			SUM(R.PROD_QTY) AS PROD_QTY
		FROM(
			SELECT 
				L.LOCATIONID, 
				ISNULL(SUM(B.PROD_QTY),0) AS PROD_QTY
			FROM
				DSP_LOCATION L
			LEFT JOIN DSP_WORKDAILY_REPORT A 
			ON L.LOCATIONID = A.LINEID
				AND A.WORK_DATE BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112)
				AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112)
			LEFT JOIN DSP_WORK_CONTENTS B 
			ON A.DATASEQ = B.WORKDAILY_SEQ
			WHERE
				L.FACTORYID = #{plant}
				AND L.ISUSABLE='Y'
			GROUP BY L.LOCATIONID, B.PROD_QTY , A.WORK_DATE
			)R
		GROUP BY R.LOCATIONID
		ORDER BY PROD_QTY DESC, R.LOCATIONID ASC;
	</select>

	<select id="chart15" parameterType="FairProd" resultType="FairProd">
		SELECT 
			E.dt,
			E.LINEID,
			SUM(E.PROD_QTY) AS PROD_QTY,
			SUM(E.WORKTOTAL) AS WORKTOTAL,
			SUM(E.NOTOPERATETOTAL) AS NOTOPERATETOTAL
		FROM (
			SELECT 
				<choose>
					<when test='month == "day"'>
						A.dt AS dt,
					</when>
					<when test='month == "week"'>
						CONCAT(DATEPART( MONTH, DATEADD( DAY, ( ( 7 - DATEPART( WEEKDAY, A.dt ) ) % 7 ) - 3, A.dt ) ), '0',( DATEPART( DAY, DATEADD( DAY, ( ( 7 - DATEPART( WEEKDAY, A.dt) ) % 7 ) - 3, A.dt ) ) - 1 ) / 7 + 1) AS dt,
					</when>
					<otherwise>
						DATEPART(MONTH, A.dt) AS dt,
					</otherwise>
				</choose>
				(SELECT 
					LOCATIONNAME  
				FROM DSP_LOCATION 
				WHERE LOCATIONID = ISNULL(B.LINEID, #{line})) AS LINEID,
				ISNULL(CASE 
				    WHEN (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) 
				    THEN ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)))
				    ELSE ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT))))
				END, 0) AS WORKTOTAL,
				ISNULL(CASE 
				    WHEN (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) 
				    THEN ((CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT)))
				    ELSE ((CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT))))
				END, 0) AS NOTOPERATETOTAL,
				ISNULL(SUM(C.PROD_QTY),0) AS PROD_QTY
			FROM CheckDayOff A 
			LEFT JOIN DSP_WORKDAILY_REPORT B 
			ON B.WORK_DATE =A.dt
				AND B.LINEID = #{line}
				AND B.ISUSABLE ='Usable'
				AND B.MATERIALID = #{material}
			LEFT JOIN DSP_WORK_CONTENTS C 
			ON B.DATASEQ =C.WORKDAILY_SEQ
				AND C.ISUSABLE ='Usable'
			LEFT JOIN DSP_NOTOPERATE_CONTENTS D
			ON B.DATASEQ =D.WORKDAILY_SEQ
				AND D.ISUSABLE ='Usable'
			WHERE 1=1
			<choose>
				<when test='month == "day"'>
					AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112)
				</when>
				<when test='month == "week"'>
					AND A.dt BETWEEN CONVERT(VARCHAR(8),DATEADD(DAY, 1 - DATEPART(DW, CONVERT(DATE,GETDATE()-35)) , CONVERT(DATE,GETDATE()-35)),112) 
								 AND CONVERT(VARCHAR(8),DATEADD(DAY, 7 - DATEPART(DW, CONVERT(DATE,GETDATE())) , CONVERT(DATE,GETDATE())),112)	
				</when>
				<otherwise>
					AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, 0, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0))
				</otherwise>
			</choose>
			GROUP BY A.dt,B.LINEID, C.WORKTIME_FROM, C.WORKTIME_TO, D.NOTOPERATETIME_FROM, D.NOTOPERATETIME_TO
		) E
		GROUP BY E.dt, E.LINEID
		ORDER BY E.dt ASC
	</select>
	
	<select id="chart3" parameterType="FairProd" resultType="FairProd">
		SELECT DISTINCT
			F.dt,
			F.REJECT_ITEMID,
			F.COMM_GRP_CD_NM,
			SUM(F.FIRSTTIME_REJECT_QTY_SUM) AS FIRSTTIME_REJECT_QTY_SUM
		FROM(
			SELECT 
				DATEPART(MONTH, A.dt) AS dt,
				D.REJECT_ITEMID,
				E.COMM_GRP_CD_NM,
				SUM(D.FIRSTTIME_REJECT_QTY) AS FIRSTTIME_REJECT_QTY_SUM
			FROM CheckDayOff A 
			LEFT JOIN DSP_WORKDAILY_REPORT B 
			ON B.WORK_DATE =A.dt
				AND B.FACTORYID = #{plant}
				AND B.ISUSABLE ='Usable'
				AND B.MATERIALID = #{material}
			LEFT JOIN DSP_WORK_CONTENTS C 
			ON B.DATASEQ =C.WORKDAILY_SEQ
				AND C.ISUSABLE ='Usable'
			LEFT JOIN DSP_REJECT_CONTENTS D
			ON B.DATASEQ =D.WORKDAILY_SEQ
				AND D.ISUSABLE ='Usable'
			LEFT JOIN SC_COMM_GRP_CD E
			ON D.REJECT_ITEMID =E.COMM_GRP_CD 
				AND E.USE_YN  ='Y'
			WHERE DATEPART(MONTH, A.dt) = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0))
				AND	D.REJECT_ITEMID IS NOT NULL 
				AND	D.REJECT_TYPE IS NOT NULL  
			GROUP BY A.dt, D.REJECT_ITEMID, E.COMM_GRP_CD_NM
			) F
				
		GROUP BY F.dt, F.REJECT_ITEMID, F.COMM_GRP_CD_NM
		ORDER BY F.REJECT_ITEMID ASC
	</select>
		
	<select id="chart4" parameterType="FairProd" resultType="FairProd">
        SELECT DISTINCT
			G.dt,
			G.REJECT_ITEMID,
			G.REJECT_TYPE,
			G.COMM_CD_NM,
			G.COMM_GRP_CD_NM,
			SUM(G.FIRSTTIME_REJECT_QTY_SUM) AS FIRSTTIME_REJECT_QTY_SUM
		FROM(
			SELECT 
				DATEPART(MONTH, A.dt) AS dt,
				D.REJECT_ITEMID,
				D.REJECT_TYPE,
				E.COMM_CD_NM,
				F.COMM_GRP_CD_NM,
				SUM(D.FIRSTTIME_REJECT_QTY) AS FIRSTTIME_REJECT_QTY_SUM
			FROM CheckDayOff A 
			LEFT JOIN DSP_WORKDAILY_REPORT B 
			ON B.WORK_DATE =A.dt
				AND B.FACTORYID = #{plant}
				AND B.ISUSABLE ='Usable'
				AND B.MATERIALID = #{material}
			LEFT JOIN DSP_WORK_CONTENTS C 
			ON B.DATASEQ =C.WORKDAILY_SEQ
				AND C.ISUSABLE ='Usable'
			LEFT JOIN DSP_REJECT_CONTENTS D
			ON B.DATASEQ =D.WORKDAILY_SEQ
				AND D.ISUSABLE ='Usable'
			LEFT JOIN SC_COMM_CD E
			ON D.REJECT_ITEMID = E.COMM_GRP_CD 
				AND D.REJECT_TYPE = E.COMM_CD 
				AND E.USE_YN  ='Y'
			LEFT JOIN SC_COMM_GRP_CD F
			ON D.REJECT_ITEMID =F.COMM_GRP_CD 
				AND F.USE_YN  ='Y'
			WHERE DATEPART(MONTH, A.dt) = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0))
				AND	D.REJECT_ITEMID IS NOT NULL 
				AND	D.REJECT_TYPE IS NOT NULL  
			GROUP BY A.dt, D.REJECT_ITEMID, D.REJECT_TYPE, E.COMM_CD_NM, F.COMM_GRP_CD_NM
			) G
		GROUP BY G.dt, G.REJECT_ITEMID, G.REJECT_TYPE, G.COMM_CD_NM, G.COMM_GRP_CD_NM
		ORDER BY G.REJECT_ITEMID, G.REJECT_TYPE ASC
    </select>
    
	<select id="chart6" parameterType="FairProd" resultType="FairProd">
		SELECT	D.dt,
			SUM(D.PLAN_QTY) AS PLAN_QTY,
			SUM(D.PROD_QTY) AS PROD_QTY
			FROM(
				SELECT 
					CASE
				   		WHEN 'day' = #{month} THEN A.dt 
				   		WHEN 'week' = #{month} THEN CAST(CONVERT(VARCHAR(2), DATEPART(MONTH, A.dt)) AS INT) * 100 + CAST(CONVERT(VARCHAR(2), DATEDIFF(WEEK, DATEADD(MONTH, DATEDIFF(MONTH, 0, convert(varchar(10),A.dt,120)), 0),convert(varchar(10),A.dt,120)) +1) AS INT)
				   		WHEN 'month' = #{month} THEN DATEPART(MONTH, A.dt)
				   	END AS dt,
					ISNULL(SUM(B.PLAN_QTY),0) AS PLAN_QTY,
					ISNULL(SUM(C.PROD_QTY),0) AS PROD_QTY
				FROM CheckDayOff A 
				LEFT JOIN DSP_WORKDAILY_REPORT B 
				ON B.WORK_DATE = A.dt
					AND B.FACTORYID = #{plant}
					AND B.ISUSABLE = 'Usable'
					AND B.MATERIALID = #{material}
				LEFT JOIN DSP_WORK_CONTENTS C 
				ON B.DATASEQ = C.WORKDAILY_SEQ
					AND C.ISUSABLE = 'Usable'
				WHERE ('day'= #{month} AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112))
				OR	  ('week' = #{month} AND A.dt BETWEEN DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) -5, 0) AND DATEADD(MS, 0, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0)))
				OR	  ('month' = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0)))
				GROUP BY A.dt
			) D
			GROUP BY D.dt;
	</select>	
	
	<select id="chart8" parameterType="FairProd" resultType="FairProd">
		SELECT   
	         D.dt,
	         SUM(D.CNT) AS CNT
	    FROM(
	         SELECT 
	            CASE
	                WHEN 'day' = #{month} THEN A.dt
	                WHEN 'week' = #{month} THEN CAST(CONVERT(VARCHAR(2), DATEPART(MONTH, A.dt)) AS INT) * 100 + CAST(CONVERT(VARCHAR(2), DATEDIFF(WEEK, DATEADD(MONTH, DATEDIFF(MONTH, 0, convert(varchar(10),A.dt,120)), 0),convert(varchar(10),A.dt,120)) +1) AS INT)
	                WHEN 'month' = #{month} THEN DATEPART(MONTH, A.dt)
	            END AS dt,
	            COUNT(*) AS CNT  
	         FROM CheckDayOff A 
	         LEFT JOIN DSP_ANOMALYDETECT_NOTICE B 
	         ON FORMAT(B.NOTICE_DATETIME,'yyyyMMdd') = A.dt
	            AND B.ISUSABLE = 'Usable'
	            AND FACTORYID = 'KEM'
	         WHERE ('day'= #{month} AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112))
	         OR    ('week' = #{month} AND A.dt BETWEEN DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0)))
	         OR    ('month' = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0)))
	         GROUP BY A.dt
	    ) D
	    GROUP BY D.dt;
	</select>		

    <select id="find1Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'UNDER-PRODUCTION'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND ISUSABLE = 'Usable'
	</select>
	
	<select id="find1AlarmConfirm" resultType="String">
       	SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE A
        JOIN DSP_ANOMALYDETECT_CONFIRM B
        	ON A.TID = B.TID
        	AND A.NOTICE_REASON = B.CONFIRM_REASON
        WHERE 1=1
        	AND B.CONFIRM_REASON = 'UNDER-PRODUCTION'
        	AND FORMAT(A.NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND A.FACTORYID = B.FACTORYID
        	AND A.ISUSABLE = B.ISUSABLE
        	AND A.ISUSABLE = 'Usable'
	</select>
    
	<select id="find2Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'DEFECT-RATE'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND ISUSABLE = 'Usable'
    </select>   
    
	<select id="find2AlarmConfirm" resultType="String">
       	SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE A
        JOIN DSP_ANOMALYDETECT_CONFIRM B
        	ON A.TID = B.TID
        	AND A.NOTICE_REASON = B.CONFIRM_REASON
        WHERE 1=1
        	AND B.CONFIRM_REASON = 'DEFECT-RATE'
        	AND FORMAT(A.NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND A.FACTORYID = B.FACTORYID
        	AND A.ISUSABLE = B.ISUSABLE
        	AND A.ISUSABLE = 'Usable'
    </select>     
    
	<select id="find3Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'NOTOPERATE-PRESS'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND ISUSABLE = 'Usable'
    </select>  
    
	<select id="find3AlarmConfirm" resultType="String">
       	SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE A
        JOIN DSP_ANOMALYDETECT_CONFIRM B
        	ON A.TID = B.TID
        	AND A.NOTICE_REASON = B.CONFIRM_REASON
        WHERE 1=1
        	AND B.CONFIRM_REASON = 'NOTOPERATE-PRESS'
        	AND FORMAT(A.NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND A.FACTORYID = B.FACTORYID
        	AND A.ISUSABLE = B.ISUSABLE
        	AND A.ISUSABLE = 'Usable'
    </select>     

	<select id="findAllDailyAlarm" parameterType="FairProd" resultType="FairProd">
		SELECT 
			B.DATE AS DATE,
			SUM(B.COUNT) AS SUM
		FROM (
			SELECT FORMAT(A.NOTICE_DATETIME,'yyyy-MM-dd') AS DATE,
				COUNT(*) as COUNT
	        FROM DSP_ANOMALYDETECT_NOTICE as A
	        WHERE 1=1
	        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') IN (
	        												FORMAT(GETDATE(),'yyyy-MM-dd'),
	        												FORMAT(GETDATE() -1,'yyyy-MM-dd')
	        	)
	        	AND FACTORYID = 'KEM'
	        	AND ISUSABLE = 'Usable'
	        GROUP BY FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') 	
	    ) B
	    GROUP BY B.DATE
    </select>
    
</mapper>