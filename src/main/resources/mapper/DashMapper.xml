<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idr.pdd.mapper.DashMapper">

	<select id="findAllPQCD" parameterType="Dash" resultType="Dash">
        SELECT
		    D.WORK_DATE,
			SUM(D.PROD_QTY) AS PROD_QTY, 
		    SUM(D.FIRSTTIME_FAIL_QTY) AS FIRSTTIME_FAIL_QTY,
		    SUM(D.MANHOUR) AS MANHOUR,
		    SUM(D.PLAN_QTY) AS PLAN_QTY,
		    SUM(D.WORKTOTAL) AS WORKTOTAL,
			SUM(D.NOTOPERATETOTAL) AS NOTOPERATETOTAL
		FROM (
				SELECT  DISTINCT 
						B.WORK_DATE,
						C.PROD_QTY AS PROD_QTY,
						C.FIRSTTIME_FAIL_QTY AS FIRSTTIME_FAIL_QTY,
						C.MANHOUR AS MANHOUR,
						B.PLAN_QTY AS PLAN_QTY,
						CASE 
				          WHEN (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) 
				          THEN ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)))
				          ELSE ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT))))
				       	END AS WORKTOTAL,
						
				       	CASE 
				          WHEN (CAST(SUBSTRING(A.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(A.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_TO,3,2) AS INT)) 
				          THEN ((CAST(SUBSTRING(A.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(A.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_FROM,3,2) AS INT)))
				          ELSE ((CAST(SUBSTRING(A.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(A.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(A.NOTOPERATETIME_FROM,3,2) AS INT))))
				       	END AS NOTOPERATETOTAL
				FROM DSP_NOTOPERATE_CONTENTS A
				JOIN DSP_WORKDAILY_REPORT B
				ON B.DATASEQ = A.WORKDAILY_SEQ 
				AND B.FACTORYID = 'KEM'
				AND B.ISUSABLE = 'USABLE'
				AND A.ISUSABLE = 'USABLE'
				JOIN DSP_WORK_CONTENTS C
				ON B.DATASEQ = C.WORKDAILY_SEQ
				AND C.ISUSABLE = 'USABLE'
			) D	
		WHERE  D.WORK_DATE IN (
		    				CONVERT(DATE, GETDATE(), 112)
		    				,CONVERT(DATE, GETDATE()-1, 112)
		    )
		GROUP BY D.WORK_DATE
    </select>

	<select id="findAllR" parameterType="Dash" resultType="Dash">
        SELECT DISTINCT
			E.dt,
			E.REJECT_ITEMID,
			E.REJECT_TYPE,
			SUM(E.FIRSTTIME_REJECT_QTY_SUM) AS FIRSTTIME_REJECT_QTY_SUM
		FROM(
			SELECT 
				DATEPART(MONTH, A.dt) AS dt,
				D.REJECT_ITEMID,
				D.REJECT_TYPE,
				SUM(D.FIRSTTIME_REJECT_QTY) AS FIRSTTIME_REJECT_QTY_SUM
			FROM CheckDayOff A 
			LEFT JOIN DSP_WORKDAILY_REPORT B 
			ON B.WORK_DATE =A.dt
				AND B.FACTORYID = 'KEM'
				AND B.ISUSABLE ='Usable'
			LEFT JOIN DSP_WORK_CONTENTS C 
			ON B.DATASEQ =C.WORKDAILY_SEQ
				AND C.ISUSABLE ='Usable'
			LEFT JOIN DSP_REJECT_CONTENTS D
			ON B.DATASEQ =D.WORKDAILY_SEQ
				AND D.ISUSABLE ='Usable'
			WHERE DATEPART(MONTH, A.dt) = '8' AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0))
				AND	D.REJECT_ITEMID IS NOT NULL 
				AND	D.REJECT_TYPE IS NOT NULL  
			GROUP BY A.dt, D.REJECT_ITEMID, D.REJECT_TYPE 
			) E
		GROUP BY E.dt, E.REJECT_ITEMID, E.REJECT_TYPE
    </select>

	<select id="rank">
		SELECT 
			R.LOCATIONID, 
			SUM(R.PROD_QTY) AS PROD_QTY
		FROM(
			SELECT 
				L.LOCATIONID, 
				ISNULL(SUM(B.PROD_QTY),0) AS PROD_QTY
			FROM
				DSP_LOCATION L
			LEFT JOIN DSP_WORKDAILY_REPORT A 
			ON L.LOCATIONID = A.LINEID
				AND A.WORK_DATE BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112)
				AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112)
			LEFT JOIN DSP_WORK_CONTENTS B 
			ON A.DATASEQ = B.WORKDAILY_SEQ
			WHERE
				L.FACTORYID = #{data}
				AND L.ISUSABLE='Y'
			GROUP BY L.LOCATIONID, B.PROD_QTY , A.WORK_DATE
			)R
		GROUP BY R.LOCATIONID
		ORDER BY PROD_QTY DESC, R.LOCATIONID ASC;
	</select>

	<select id="chart1" resultType="Dash" parameterType="String">
		SELECT DISTINCT
			E.dt,
			E.LINEID,
			SUM(E.PROD_QTY) AS PROD_QTY,
			SUM(E.WORKTOTAL) AS WORKTOTAL,
			SUM(E.NOTOPERATETOTAL) AS NOTOPERATETOTAL
		FROM (
			SELECT 
				CASE
			   		WHEN 'day' = #{month} THEN A.dt 
			   		WHEN 'week' = #{month} THEN CAST(CONVERT(VARCHAR(2), DATEPART(MONTH, A.dt)) AS INT) * 100 + CAST(CONVERT(VARCHAR(2), DATEDIFF(WEEK, DATEADD(MONTH, DATEDIFF(MONTH, 0, convert(varchar(10),A.dt,120)), 0),convert(varchar(10),A.dt,120)) +1) AS INT)
			   		WHEN 'month' = #{month} THEN DATEPART(MONTH, A.dt)
			   	END AS dt,
				(SELECT 
					LOCATIONNAME  
				FROM DSP_LOCATION 
				WHERE LOCATIONID = ISNULL(B.LINEID, #{factory})) AS LINEID,
				
				ISNULL(CASE 
				    WHEN (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) 
				    THEN ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT)))
				    ELSE ((CAST(SUBSTRING(C.WORKTIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(C.WORKTIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(C.WORKTIME_FROM,3,2) AS INT))))
				END, 0) AS WORKTOTAL,
						
				ISNULL(CASE 
				    WHEN (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT)) &lt;= (CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) 
				    THEN ((CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) - (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT)))
				    ELSE ((CAST(SUBSTRING(D.NOTOPERATETIME_TO,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_TO,3,2) AS INT)) + (1440 - (CAST(SUBSTRING(D.NOTOPERATETIME_FROM,1,2) AS INT)*60 + CAST(SUBSTRING(D.NOTOPERATETIME_FROM,3,2) AS INT))))
				END, 0) AS NOTOPERATETOTAL,
				ISNULL(SUM(C.PROD_QTY),0) AS PROD_QTY
			FROM CheckDayOff A 
			LEFT JOIN DSP_WORKDAILY_REPORT B 
			ON B.WORK_DATE =A.dt
				AND B.LINEID = #{factory}
			LEFT JOIN DSP_WORK_CONTENTS C 
			ON B.DATASEQ =C.WORKDAILY_SEQ
				AND C.ISUSABLE ='Usable'
			LEFT JOIN DSP_NOTOPERATE_CONTENTS D
			ON B.DATASEQ =D.WORKDAILY_SEQ
				AND D.ISUSABLE ='Usable'
			WHERE 'day'= #{month} AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112)
			OR	  'week' = #{month} AND A.dt BETWEEN DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0))
			OR	  'month' = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0))
			GROUP BY A.dt,B.LINEID, C.WORKTIME_FROM, C.WORKTIME_TO, D.NOTOPERATETIME_FROM, D.NOTOPERATETIME_TO
		) E
		GROUP BY E.dt, E.LINEID
	</select>
	
	<select id="chart6" parameterType="FairProd" resultType="FairProd">
		SELECT	D.dt,
			SUM(D.PLAN_QTY) AS PLAN_QTY,
			SUM(D.PROD_QTY) AS PROD_QTY
			FROM(
				SELECT 
					CASE
				   		WHEN 'day' = #{month} THEN A.dt 
				   		WHEN 'week' = #{month} THEN CAST(CONVERT(VARCHAR(2), DATEPART(MONTH, A.dt)) AS INT) * 100 + CAST(CONVERT(VARCHAR(2), DATEDIFF(WEEK, DATEADD(MONTH, DATEDIFF(MONTH, 0, convert(varchar(10),A.dt,120)), 0),convert(varchar(10),A.dt,120)) +1) AS INT)
				   		WHEN 'month' = #{month} THEN DATEPART(MONTH, A.dt)
				   	END AS dt,
					ISNULL(SUM(B.PLAN_QTY),0) AS PLAN_QTY,
					ISNULL(SUM(C.PROD_QTY),0) AS PROD_QTY
				FROM CheckDayOff A 
				LEFT JOIN DSP_WORKDAILY_REPORT B 
				ON B.WORK_DATE = A.dt
				LEFT JOIN DSP_WORK_CONTENTS C 
				ON B.DATASEQ = C.WORKDAILY_SEQ
					AND C.ISUSABLE = 'Usable'
				WHERE ('day'= #{month} AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112))
				OR	  ('week' = #{month} AND A.dt BETWEEN DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0)))
				OR	  ('month' = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0)))
				GROUP BY A.dt
			) D
			GROUP BY D.dt;
	</select>	
	
	<select id="chart8" parameterType="FairProd" resultType="FairProd">
		SELECT   
	            D.dt,
	            SUM(D.CNT) AS CNT
	        FROM(
	            SELECT 
	               CASE
	                   WHEN 'day' = #{month} THEN A.dt
	                   WHEN 'week' = #{month} THEN CAST(CONVERT(VARCHAR(2), DATEPART(MONTH, A.dt)) AS INT) * 100 + CAST(CONVERT(VARCHAR(2), DATEDIFF(WEEK, DATEADD(MONTH, DATEDIFF(MONTH, 0, convert(varchar(10),A.dt,120)), 0),convert(varchar(10),A.dt,120)) +1) AS INT)
	                   WHEN 'month' = #{month} THEN DATEPART(MONTH, A.dt)
	               END AS dt,
	               COUNT(*) AS CNT  
	            FROM CheckDayOff A 
	            LEFT JOIN DSP_ANOMALYDETECT_NOTICE B 
	            ON FORMAT(B.NOTICE_DATETIME,'yyyyMMdd') = A.dt
	               AND B.ISUSABLE = 'Usable'
	               AND FACTORYID = 'KEM'
	            WHERE ('day'= #{month} AND A.dt BETWEEN CONVERT(VARCHAR(8), DATEADD(DAY,-5,GETDATE()),112) AND CONVERT(VARCHAR(8), DATEADD(DAY, 0, GETDATE()),112))
	            OR    ('week' = #{month} AND A.dt BETWEEN DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()), 0)))
	            OR    ('month' = #{month} AND A.dt BETWEEN DATEADD(MONTH , DATEDIFF(MONTH, 0, GETDATE()) -5, 0) AND DATEADD(MS, -3, DATEADD(WK, DATEDIFF(WK, 0, GETDATE()) +1, 0)))
	            GROUP BY A.dt
	        ) D
	        GROUP BY D.dt;
	</select>		

    <select id="find1Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'UNDER-PRODUCTION'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND FACTORYID = 'KEM'
        	AND ISUSABLE = 'Usable'
	</select>
    
	<select id="find2Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'DEFECT-RATE'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND FACTORYID = 'KEM'
        	AND ISUSABLE = 'Usable'
    </select>   
    
	<select id="find3Alarm" resultType="String">
		SELECT COUNT(*)
        FROM DSP_ANOMALYDETECT_NOTICE as A
        WHERE 1=1
        	AND NOTICE_REASON = 'NOTOPERATE-PRESS'
        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') = (FORMAT(GETDATE(),'yyyy-MM-dd'))
        	AND FACTORYID = 'KEM'
        	AND ISUSABLE = 'Usable'
    </select>  

	<select id="findAllDailyAlarm" parameterType="Dash" resultType="Dash">
		SELECT 
			B.DATE AS DATE,
			SUM(B.COUNT) AS SUM
		FROM (
			SELECT FORMAT(A.NOTICE_DATETIME,'yyyy-MM-dd') AS DATE,
				COUNT(*) as COUNT
	        FROM DSP_ANOMALYDETECT_NOTICE as A
	        WHERE 1=1
	        	AND FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') IN (
	        												FORMAT(GETDATE(),'yyyy-MM-dd'),
	        												FORMAT(GETDATE() -1,'yyyy-MM-dd')
	        	)
	        	AND FACTORYID = 'KEM'
	        	AND ISUSABLE = 'Usable'
	        GROUP BY FORMAT(NOTICE_DATETIME,'yyyy-MM-dd') 	
	    ) B
	    GROUP BY B.DATE
    </select>
    
</mapper>