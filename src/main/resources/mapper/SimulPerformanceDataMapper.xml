<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.idr.pdd.mapper.SimulPerformanceDataMapper">

	<select id="sundaycount" parameterType="String">
		SELECT
		COUNT(*)AS SUNDAY,
		(SELECT COUNT(*)FROM CheckDayOff WHERE dt BETWEEN CONVERT(DATE,
		#{start})
		AND CONVERT(DATE, #{end}))AS TOTAL
		FROM CheckDayOff
		WHERE dt
		BETWEEN CONVERT(DATE, #{start}) AND CONVERT(DATE,
		#{end})
		AND flag =1
	</select>

	<select id="productplanfind" parameterType="String"
		resultType="PerByProductPlan">
		SELECT
		ORDER_NAME AS 생산계획명,
		ITEM_ID AS 자재코드,
		ITEM_NAME AS 자재명,
		(SELECT
		COUNT(*)FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME)AS 총공정수,
		COUNT(*)AS 공정수행횟수,
		(SELECT COUNT(*)FROM
		SIMULLATOR_FAIR_PERFORMANCE WHERE PROCESS_RESULT ='불량'
		AND
		ORDER_NAME=A.ORDER_NAME)AS 불량횟수,
		(SELECT (SELECT COUNT(*)FROM
		SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME)-COUNT(*)FROM SIMULLATOR_FAIR_PERFORMANCE
		WHERE ORDER_NAME=A.ORDER_NAME) AS 남은횟수,
		(SELECT TOP 1 START_TIME FROM
		SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND
		CREATETIME BETWEEN CONVERT(DATE,
		#{start}) AND CONVERT(DATE, #{end}))AS
		시작시간,
		(SELECT TOP 1 END_TIME FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND CREATETIME BETWEEN CONVERT(DATE,
		#{start})
		AND CONVERT(DATE, #{end}))AS 종료시간,
		(SELECT DELIVERY FROM
		SIMULLATOR_PRODUCTION_PLANNING WHERE ORDER_ID=(SELECT
		DISTINCT ORDER_ID
		FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME))AS 납기,
		DATEDIFF(SS,(SELECT TOP 1 START_TIME FROM SIMULLATOR_FAIR_PERFORMANCE
		WHERE
		ORDER_NAME=A.ORDER_NAME AND CREATETIME BETWEEN CONVERT(DATE,
		#{start}) AND CONVERT(DATE,#{end})),
		(SELECT TOP 1 END_TIME FROM
		SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND
		CREATETIME BETWEEN CONVERT(DATE,
		#{start}) AND CONVERT(DATE, #{end})))
		AS 소요시간,
		(SELECT (COUNT(*)/(SELECT COUNT(*)FROM
		SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME)*100)
		FROM
		SIMULLATOR_PRODUCTION_PLANNING P JOIN SIMULLATOR_FAIR_PERFORMANCE F
		ON
		F.START_TIME BETWEEN CONVERT(DATE, P.START_TIME) AND CONVERT(DATE,
		P.DELIVERY)
		WHERE P.ORDER_NAME=A.ORDER_NAME )AS 납기준수율
		FROM
		SIMULLATOR_FAIR_PERFORMANCE A
		WHERE CREATETIME BETWEEN CONVERT(DATE,
		#{start}) AND CONVERT(DATE,
		#{end})
		GROUP BY
		ORDER_NAME,ITEM_NAME,ITEM_ID
	</select>

	<select id="performanceByProcess" parameterType="String"
		resultType="performanceByProcess">

		SELECT
		ORDER_NAME,
		ITEM_ID,
		ITEM_NAME,
		PROCESS_NAME,
		CAST(SUM(CONVERT(NUMERIC(5, 2), PROCESS_TIME)) / COUNT(*) AS NUMERIC(5, 2)) AS AVG_PROCESS_TIME,
		(SELECT COUNT(*)FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND ITEM_NAME=A.ITEM_NAME AND
		PROCESS_NAME=A.PROCESS_NAME)AS TOTAL_PNUM,
		COUNT(*)AS PROCESS_PER_NUM,
		(SELECT COUNT(*)FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND ITEM_NAME=A.ITEM_NAME AND
		PROCESS_NAME=A.PROCESS_NAME AND PROCESS_RESULT ='불량'
		AND START_TIME BETWEEN CONVERT(DATE, #{start}) AND CONVERT(DATE,
		#{end})
		AND END_TIME BETWEEN CONVERT(DATE, #{start}) AND CONVERT(DATE,
		#{end}))AS BAD_NUM,
		(SELECT
		(SELECT COUNT(*)
		FROM SIMULLATOR_FAIR_PERFORMANCE
		WHERE ORDER_NAME=A.ORDER_NAME AND ITEM_NAME=A.ITEM_NAME AND
		PROCESS_NAME=A.PROCESS_NAME)
		-COUNT(*)FROM SIMULLATOR_FAIR_PERFORMANCE WHERE ORDER_NAME=A.ORDER_NAME AND
		ITEM_NAME=A.ITEM_NAME AND PROCESS_NAME=A.PROCESS_NAME
		) AS REMAINING,
		MIN(START_TIME)AS START_TIME,
		MAX(END_TIME)AS END_TIME,
		DATEDIFF(SS,(SELECT TOP 1 START_TIME FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND ITEM_NAME=A.ITEM_NAME AND
		PROCESS_NAME=A.PROCESS_NAME
		AND CREATETIME BETWEEN CONVERT(DATE, #{start}) AND CONVERT(DATE,
		#{end})),
		(SELECT TOP 1 END_TIME FROM SIMULLATOR_FAIR_PERFORMANCE WHERE
		ORDER_NAME=A.ORDER_NAME AND ITEM_NAME=A.ITEM_NAME AND
		PROCESS_NAME=A.PROCESS_NAME AND CREATETIME BETWEEN CONVERT(DATE,
		#{start}) AND CONVERT(DATE, #{end})))
		AS TAKEN_TIME
		FROM
		SIMULLATOR_FAIR_PERFORMANCE A
		WHERE
		START_TIME BETWEEN CONVERT(DATE, #{start}) AND CONVERT(DATE, #{end})
		GROUP BY
		ORDER_NAME,
		ITEM_ID,
		ITEM_NAME,
		PROCESS_NAME;





	</select>



</mapper>
